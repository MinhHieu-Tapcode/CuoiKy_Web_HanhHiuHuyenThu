<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        @import url('../asset/css/main.css');

        body {
            background-color: #fff;
        }

        .card {
            background-color: #f7f7f7;
            border: 1px solid #e3e3e3;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .home-link {
            color: #2e2e2e;
            text-decoration: none;
            padding: 10px 20px;
            margin-bottom: 24px;
            display: inline-block;
            border-radius: 6px;
            background-color: #f7f7f7;
            border: 1px solid #e3e3e3;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .home-link:hover {
            background-color: #e8c89a;
        }

        .home-link i {
            margin-right: 8px;
        }

        .form-label {
            color: #2e2e2e;
            font-weight: 500;
        }

        .form-control,
        .form-select {
            border: 2px solid #e3e3e3;
            border-radius: 8px;
            font-size: 14px;
            padding: 10px;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #e3e3e3;
            box-shadow: none;
        }

        .btn-primary.buttonCheckout {
            background-color: #f7f7f7;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary.buttonCheckout:hover {
            background-color: #e3e3e3;
        }

        .badge.bg-secondary {
            background-color: #f7f7f7;
        }

        .text-primary {
            color: #2e2e2e !important;
        }
    </style>
</head>

<body>

    <div class="container py-5">
        <a href="/Trangchu.html" class="home-link">
            <i class="bi bi-arrow-left"></i> Quay về trang chủ
        </a>

        <div class="row g-4">
            <!-- Left Column - Cart Items -->
            <div class="col-12 col-lg-8">
                <div class="card shadow">
                    <div class="card-body">
                        <h2 class="h4 mb-4">Danh sách sản phẩm</h2>
                        <div class="list">
                            <!-- Products will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Form -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h2 class="h4 mb-4">Đơn hàng</h2>
                        <form class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="name" class="form-label">Họ và tên</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>

                            <div class="mb-3">
                                <label for="phone" class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label">Địa chỉ</label>
                                <input type="text" class="form-control" id="address" required>
                            </div>

                            <div class="mb-3">
                                <label for="country" class="form-label">Quốc gia</label>
                                <select class="form-select" id="country" required>
                                    <option value="">Chọn...</option>
                                    <option value="Vietnam">Việt Nam</option>
                                    <option value="Kingdom">Kingdom</option>
                                </select>
                            </div>

                            <div class="mb-3" id="city-group" style="display: none;">
                                <label for="city" class="form-label">Tỉnh / Thành phố</label>
                                <select class="form-select" id="city" required>
                                    <option value="">Chọn...</option>
                                </select>
                            </div>

                            <hr class="my-4">

                            <div class="d-flex justify-content-between mb-2">
                                <span>Tổng sản phẩm:</span>
                                <span class="totalQuantity fw-bold">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-4">
                                <span>Thành tiền:</span>
                                <span class="totalPrice fw-bold text-primary">0</span>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 buttonCheckout"
                                style="background-color: #2e2e2e;">
                                Đặt hàng
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>

<script>
    // ================= KHỞI TẠO EMAILJS =================
    emailjs.init("jyEtAUcgjqpxB9Mar");
    // ====================================================

    // ✅ FIX: lấy user đăng nhập
    const user = JSON.parse(localStorage.getItem("user"));
    // user ví dụ: { "name": "Hiếu", "email": "test@gmail.com" }

    // DOM
    const countrySelect = document.getElementById("country");
    const citySelect = document.getElementById("city");
    const cityGroup = document.getElementById("city-group");

    const vietnamCities = [
        "An Giang","Bà Rịa - Vũng Tàu","Bắc Giang","Bắc Kạn","Bạc Liêu","Bắc Ninh",
        "Bến Tre","Bình Định","Bình Dương","Bình Phước","Bình Thuận","Cà Mau",
        "Cần Thơ","Cao Bằng","Đà Nẵng","Đắk Lắk","Đắk Nông","Điện Biên","Đồng Nai",
        "Đồng Tháp","Gia Lai","Hà Giang","Hà Nam","Hà Nội","Hà Tĩnh","Hải Dương",
        "Hải Phòng","Hậu Giang","Hòa Bình","Hưng Yên","Khánh Hòa","Kiên Giang",
        "Kon Tum","Lai Châu","Lâm Đồng","Lạng Sơn","Lào Cai","Long An","Nam Định",
        "Nghệ An","Ninh Bình","Ninh Thuận","Phú Thọ","Phú Yên","Quảng Bình",
        "Quảng Nam","Quảng Ngãi","Quảng Ninh","Quảng Trị","Sóc Trăng","Sơn La",
        "Tây Ninh","Thái Bình","Thái Nguyên","Thanh Hóa","Thừa Thiên Huế","Tiền Giang",
        "TP. Hồ Chí Minh","Trà Vinh","Tuyên Quang","Vĩnh Long","Vĩnh Phúc","Yên Bái"
    ];

    countrySelect.addEventListener("change", function () {
        citySelect.innerHTML = '<option value="">Chọn...</option>';
        if (this.value === "Vietnam") {
            cityGroup.style.display = "block";
            vietnamCities.forEach(city => {
                const option = document.createElement("option");
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        } else {
            cityGroup.style.display = "none";
        }
    });

    // ================= CART =================
    const products = JSON.parse(localStorage.getItem("cart")) || [];
    const listContainer = document.querySelector(".list");
    let totalQuantity = 0;
    let totalPrice = 0;

    products.forEach(product => {
        const price = Number(product.price) || 0;
        const qty = Number(product.quantity) || 0;
        const itemTotal = price * qty;

        totalQuantity += qty;
        totalPrice += itemTotal;

        const item = document.createElement("div");
        item.className = "card mb-3 border-0";
        item.innerHTML = `
            <div class="row g-0 align-items-center">
                <div class="col-4 col-md-2">
                    <img src="${product.preview}" class="img-fluid rounded" alt="${product.name}">
                </div>
                <div class="col-8 col-md-10">
                    <div class="card-body">
                        <h6 class="mb-1">${product.name}</h6>
                        <small class="text-muted">${price.toLocaleString("vi-VN")} ₫ x ${qty}</small>
                        <div class="fw-bold text-end">${itemTotal.toLocaleString("vi-VN")} ₫</div>
                    </div>
                </div>
            </div>
        `;
        listContainer.appendChild(item);
    });

    document.querySelector(".totalQuantity").innerText = totalQuantity;
    document.querySelector(".totalPrice").innerText =
        totalPrice.toLocaleString("vi-VN") + " ₫";

    // ================= SUBMIT + SEND EMAIL =================
    document.querySelector("form").addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!user || !user.email) {
            alert("Bạn cần đăng nhập để thanh toán!");
            return;
        }

        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const address = document.getElementById("address").value.trim();
        const country = countrySelect.value;
        const city = citySelect.value;

        if (!name || !phone || !address || !country || (country === "Vietnam" && !city)) {
            alert("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        if (products.length === 0) {
            alert("Giỏ hàng trống!");
            return;
        }

        // ❌ KHÔNG gửi ảnh – chỉ text
        const itemsList = products.map(p =>
            `- ${p.name} x${p.quantity}: ${(p.price * p.quantity).toLocaleString("vi-VN")}₫`
        ).join("\n");

        const emailData = {
            from_name: name,
            to_email: user.email,
            phone: phone,
            address: `${address}, ${city || country}`,
            message: `Danh sách sản phẩm:\n${itemsList}\n\nTổng cộng: ${totalPrice.toLocaleString("vi-VN")}₫`
        };

        try {
            await emailjs.send(
                "service_agcqc5a",
                "template_hrgoacw",
                emailData
            );

            alert("✅ Thanh toán thành công! Hóa đơn đã gửi về email.");
            localStorage.removeItem("cart");
            window.location.href = "/Trangchu.html";

        } catch (err) {
            console.error(err);
            alert("❌ Gửi email thất bại!");
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
    @import url('css/main.css');
        body {
            background-color: #fff;
        }
        .card {
            background-color: #f7f7f7;
            border: 1px solid #e3e3e3;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .home-link {
            color: #2e2e2e;
            text-decoration: none;
            padding: 10px 20px;
            margin-bottom: 24px;
            display: inline-block;
            border-radius: 6px;
            background-color: #f7f7f7;
            border: 1px solid #e3e3e3;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .home-link:hover {
            background-color: #e8c89a;
        }
        .home-link i {
            margin-right: 8px;
        }
        .form-label {
            color: #2e2e2e;
            font-weight: 500;
        }
        .form-control, .form-select {
            border: 2px solid #e3e3e3;
            border-radius: 8px;
            font-size: 14px;
            padding: 10px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #e3e3e3;
            box-shadow: none;
        }
        .btn-primary.buttonCheckout {
            background-color: #f7f7f7;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary.buttonCheckout:hover {
            background-color: #e3e3e3;
        }
        .badge.bg-secondary {
            background-color: #f7f7f7;
        }
        .text-primary {
            color: #2e2e2e !important;
        }
    </style>
</head>
<body>
    
<div class="container py-5">
    <a href="Trangchu.html" class="home-link">
        <i class="bi bi-arrow-left" ></i> Quay v·ªÅ trang ch·ªß
    </a>
    
    <div class="row g-4">
        <!-- Left Column - Cart Items -->
        <div class="col-12 col-lg-8">
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="h4 mb-4">Danh s√°ch s·∫£n ph·∫©m</h2>
                    <div class="list">
                        <!-- Products will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Order Form -->
        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h2 class="h4 mb-4">ƒê∆°n h√†ng</h2>
                    <form class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="name" class="form-label">H·ªç v√† t√™n</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">ƒê·ªãa ch·ªâ</label>
                            <input type="text" class="form-control" id="address" required>
                        </div>

                        <div class="mb-3">
                            <label for="country" class="form-label">Qu·ªëc gia</label>
                            <select class="form-select" id="country" required>
                                <option value="">Ch·ªçn...</option>
                                <option value="Vietnam">Vi·ªát Nam</option>
                                <option value="Kingdom">Kingdom</option>
                            </select>
                        </div>

                        <div class="mb-3" id="city-group" style="display: none;">
                            <label for="city" class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                            <select class="form-select" id="city" required>
                                <option value="">Ch·ªçn...</option>
                            </select>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-between mb-2">
                            <span>T·ªïng s·∫£n ph·∫©m:</span>
                            <span class="totalQuantity fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Th√†nh ti·ªÅn:</span>
                            <span class="totalPrice fw-bold text-primary">0</span>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 buttonCheckout" style="background-color: #2e2e2e;">
                            ƒê·∫∑t h√†ng
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>

<script>
  // ================= KH·ªûI T·∫†O EMAILJS =================
  emailjs.init("jyEtAUcgjqpxB9Mar"); // üîë Thay b·∫±ng PUBLIC_KEY c·ªßa b·∫°n
  // ======================================================

  // DOM
  const countrySelect = document.getElementById("country");
  const citySelect = document.getElementById("city");
  const cityGroup = document.getElementById("city-group");

  // Danh s√°ch t·ªânh th√†nh Vi·ªát Nam
  const vietnamCities = [
    "An Giang", "B√† R·ªãa - V≈©ng T√†u", "B·∫Øc Giang", "B·∫Øc K·∫°n", "B·∫°c Li√™u", "B·∫Øc Ninh",
    "B·∫øn Tre", "B√¨nh ƒê·ªãnh", "B√¨nh D∆∞∆°ng", "B√¨nh Ph∆∞·ªõc", "B√¨nh Thu·∫≠n", "C√† Mau",
    "C·∫ßn Th∆°", "Cao B·∫±ng", "ƒê√† N·∫µng", "ƒê·∫Øk L·∫Øk", "ƒê·∫Øk N√¥ng", "ƒêi·ªán Bi√™n", "ƒê·ªìng Nai",
    "ƒê·ªìng Th√°p", "Gia Lai", "H√† Giang", "H√† Nam", "H√† N·ªôi", "H√† Tƒ©nh", "H·∫£i D∆∞∆°ng",
    "H·∫£i Ph√≤ng", "H·∫≠u Giang", "H√≤a B√¨nh", "H∆∞ng Y√™n", "Kh√°nh H√≤a", "Ki√™n Giang",
    "Kon Tum", "Lai Ch√¢u", "L√¢m ƒê·ªìng", "L·∫°ng S∆°n", "L√†o Cai", "Long An", "Nam ƒê·ªãnh",
    "Ngh·ªá An", "Ninh B√¨nh", "Ninh Thu·∫≠n", "Ph√∫ Th·ªç", "Ph√∫ Y√™n", "Qu·∫£ng B√¨nh",
    "Qu·∫£ng Nam", "Qu·∫£ng Ng√£i", "Qu·∫£ng Ninh", "Qu·∫£ng Tr·ªã", "S√≥c TrƒÉng", "S∆°n La",
    "T√¢y Ninh", "Th√°i B√¨nh", "Th√°i Nguy√™n", "Thanh H√≥a", "Th·ª´a Thi√™n Hu·∫ø", "Ti·ªÅn Giang",
    "TP. H·ªì Ch√≠ Minh", "Tr√† Vinh", "Tuy√™n Quang", "Vƒ©nh Long", "Vƒ©nh Ph√∫c", "Y√™n B√°i"
  ];

  // Hi·ªÉn th·ªã t·ªânh/th√†nh khi ch·ªçn qu·ªëc gia
  countrySelect.addEventListener("change", function() {
    const selectedCountry = this.value;
    citySelect.innerHTML = '<option value="">Ch·ªçn...</option>';

    if (selectedCountry === "Vietnam") {
      cityGroup.style.display = "block";
      vietnamCities.forEach(city => {
        const option = document.createElement("option");
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    } else {
      cityGroup.style.display = "none";
    }
  });

  // L·∫•y s·∫£n ph·∫©m t·ª´ localStorage
  const products = JSON.parse(localStorage.getItem('cart')) || [];
  const listContainer = document.querySelector('.list');
  let totalQuantity = 0;
  let totalPrice = 0;

  if (products.length > 0) {
    products.forEach(product => {
      const price = Number(product.price) || 0;
      const itemTotal = price * (Number(product.quantity) || 0);

      const item = document.createElement('div');
      item.classList.add('card', 'mb-3', 'border-0');
      item.innerHTML = `
        <div class="row g-0 align-items-center">
          <div class="col-4 col-md-2">
            <img src="${product.preview}" class="img-fluid rounded" alt="${product.name}">
          </div>
          <div class="col-8 col-md-10">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-12 col-md-5">
                  <h5 class="card-title">${product.name}</h5>
                  <p class="card-text text-muted">${price.toLocaleString('vi-VN')} ‚Ç´ / 1 s·∫£n ph·∫©m</p>
                </div>
                <div class="col-6 col-md-3">
                  <span class="badge bg-secondary">S·ªë l∆∞·ª£ng: ${product.quantity}</span>
                </div>
                <div class="col-6 col-md-4 text-end">
                  <span class="fw-bold">${itemTotal.toLocaleString('vi-VN')} ‚Ç´</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      listContainer.appendChild(item);

      totalQuantity += Number(product.quantity) || 0;
      totalPrice += itemTotal;
    });
  }

  document.querySelector('.totalQuantity').innerText = totalQuantity;
  document.querySelector('.totalPrice').innerText = `${totalPrice.toLocaleString('vi-VN')} ‚Ç´`;

  // ================= X·ª¨ L√ù FORM SUBMIT =================
  document.querySelector('form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const address = document.getElementById('address').value;
    const country = document.getElementById('country').value;
    const city = document.getElementById('city').value;

    if (!name || !phone || !address || !country || (country === 'Vietnam' && !city)) {
      return alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    }

    if (products.length === 0) return alert("Gi·ªè h√†ng tr·ªëng!");

    // Chu·∫©n b·ªã n·ªôi dung email
    const itemsList = products.map(
      item => `- ${item.name} (${item.color || '-'}, ${item.size || '-'}) x${item.quantity}: ${item.price.toLocaleString()}‚Ç´`
    ).join("\n");

    const emailData = {
      from_name: name,
      to_email: "example@.com", // email nh·∫≠n h√≥a ƒë∆°n
      message: `C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t h√†ng!\n\nTh√¥ng tin kh√°ch h√†ng:\nH·ªç t√™n: ${name}\nSƒêT: ${phone}\nƒê·ªãa ch·ªâ: ${address}, ${city || country}\n\nDanh s√°ch s·∫£n ph·∫©m:\n${itemsList}\n\nT·ªïng c·ªông: ${totalPrice.toLocaleString()}‚Ç´`
    };

    try {
      await emailjs.send("service_agcqc5a", "template_hrgoacw", emailData);
      alert('‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng v√† email ƒë√£ ƒë∆∞·ª£c g·ª≠i!');
      localStorage.removeItem('cart');
      window.location.href = 'Trangchu.html';
    } catch (err) {
      console.error(err);
      alert('‚ùå L·ªói khi g·ª≠i email: ' + (err.text || err));
    }
  });
</script>


</body>
</html>